<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GERF-App - Real-time 3D Coordinate Streaming</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div id="container">
        <!-- Info Panel -->
        <div id="info">
            <h3>ðŸ“¡ Live Coordinates</h3>
            <div id="coordinates">
                <div>X: <span id="coord-x">--</span></div>
                <div>Y: <span id="coord-y">--</span></div>
                <div>Z: <span id="coord-z">--</span></div>
                <div>Type: <span id="trajectory-type">--</span></div>
            </div>
            <div id="status" class="status-connecting">Connecting...</div>
        </div>

        <!-- Scoring Panel -->
        <div id="scoring-panel">
            <h3>ðŸŽ¯ Dart Scoring</h3>
            
            <div class="player-input-section">
                <div class="input-group">
                    <label for="player-name">Player Name:</label>
                    <input type="text" id="player-name" placeholder="Enter player name to start..." maxlength="50">
                </div>
                <button id="toggle-details" class="btn btn-toggle">Show Details</button>
            </div>
            
            <div id="scoring-details" class="scoring-details-section" style="display: none;">
                <div class="current-throw-section">
                    <h4>Current Round</h4>
                    <div class="throw-stats">
                        <div class="stat-item">
                            <span class="stat-label">Status:</span>
                            <span class="stat-value" id="throw-status">Waiting for player name</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Round Score:</span>
                            <span class="stat-value" id="current-score">--</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Distance:</span>
                            <span class="stat-value" id="closest-distance">--</span>
                        </div>
                    </div>
                </div>
                
                <div class="session-stats-section">
                    <h4>Session Stats</h4>
                    <div class="session-stats">
                        <div class="stat-item">
                            <span class="stat-label">Rounds:</span>
                            <span class="stat-value" id="throw-count">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Total Score:</span>
                            <span class="stat-value" id="session-score">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Best Round:</span>
                            <span class="stat-value" id="best-throw">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Bullseyes:</span>
                            <span class="stat-value" id="bullseye-count">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg Score:</span>
                            <span class="stat-value" id="average-distance">0.0</span>
                        </div>
                    </div>
                </div>
                
                <div class="scoring-zones-section">
                    <h4>Scoring Zones</h4>
                    <div class="scoring-zones">
                        <div class="zone-item bullseye">
                            <span class="zone-color" style="background: #FFD700;"></span>
                            <span class="zone-name">Bullseye (â‰¤2)</span>
                            <span class="zone-points">50 pts</span>
                        </div>
                        <div class="zone-item inner">
                            <span class="zone-color" style="background: #FF6B6B;"></span>
                            <span class="zone-name">Inner (â‰¤5)</span>
                            <span class="zone-points">25 pts</span>
                        </div>
                        <div class="zone-item outer">
                            <span class="zone-color" style="background: #4ECDC4;"></span>
                            <span class="zone-name">Outer (â‰¤10)</span>
                            <span class="zone-points">10 pts</span>
                        </div>
                        <div class="zone-item miss">
                            <span class="zone-color" style="background: #95A5A6;"></span>
                            <span class="zone-name">Miss (>10)</span>
                            <span class="zone-points">0 pts</span>
                        </div>
                    </div>
                </div>
                
                <div class="throw-controls">
                    <button id="clear-history" class="btn btn-secondary">Clear History</button>
                    <button id="export-throws" class="btn btn-secondary">Export Rounds</button>
                </div>
                
                <!-- Throw History Panel (moved inside toggle) -->
                <div class="throw-history-section">
                    <h4>ðŸ“Š Recent Rounds</h4>
                    <div id="throw-history-container">
                        <p class="no-throws">No rounds completed yet</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recording Panel -->
        <div id="recording-panel" style="display: none;">
            <h3>ðŸŽ¯ Recording Control</h3>
            
            <div class="button-group">
                <button id="start-recording" class="btn btn-start">Start Recording</button>
                <button id="stop-recording" class="btn btn-stop" disabled>Stop Recording</button>
            </div>
            
            <div id="recording-status" class="recording-inactive">
                <div class="status-item">
                    <span class="status-label">Status:</span>
                    <span class="status-value" id="recording-state">Ready</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Points:</span>
                    <span class="status-value" id="points-captured">0</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Duration:</span>
                    <span class="status-value" id="recording-duration">0s</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Player:</span>
                    <span class="status-value" id="current-player">--</span>
                </div>
            </div>
            
            <!-- Recording Settings integrated here -->
            <div class="recording-settings-section">
                <h4>ðŸ’¾ Recording Settings</h4>
                
                <div class="settings-group">
                    <div class="setting-item">
                        <label>
                            <input type="checkbox" id="auto-save-toggle" checked>
                            Auto-save recordings to file
                        </label>
                    </div>
                    
                    <div class="setting-item">
                        <label for="save-location">Save Method:</label>
                        <select id="save-location">
                            <option value="download">Auto Download</option>
                            <option value="picker">Choose Location</option>
                        </select>
                    </div>
                </div>
                
                <div class="button-group">
                    <button id="export-all" class="btn btn-secondary">Export All</button>
                    <button id="view-recordings" class="btn btn-secondary">View Recordings</button>
                </div>
                
                <div id="recordings-list" class="recordings-list" style="display: none;">
                    <h4>Saved Recordings:</h4>
                    <div id="recordings-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- GLTFLoader -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    
    <!-- Application Modules -->
    <script src="js/throw-manager.js"></script>
    <script src="js/recording-manager.js"></script>
    <script src="js/scene-manager.js"></script>
    <script src="js/websocket-manager.js"></script>

    <script>
        // Application Initialization
        let sceneManager, throwManager, websocketManager;

        function init() {
            // Initialize managers
            sceneManager = new SceneManager();
            throwManager = new ThrowManager(sceneManager);
            websocketManager = new WebSocketManager(sceneManager, null, throwManager);

            // Handle window resize
            window.addEventListener('resize', () => {
                sceneManager.handleResize();
            });

            // Add keyboard shortcuts for throwing
            document.addEventListener('keydown', (event) => {
                if (event.ctrlKey || event.metaKey) {
                    switch(event.key) {
                        case 't':
                            event.preventDefault();
                            throwManager.exportRoundHistory();
                            break;
                        case 'c':
                            event.preventDefault();
                            throwManager.clearRoundHistory();
                            break;
                        case 'f':
                            event.preventDefault();
                            throwManager.forceEndThrow();
                            break;
                        case 'r':
                            event.preventDefault();
                            throwManager.forceEndRound();
                            break;
                    }
                }
            });

            console.log('ðŸš€ GERF-App initialized successfully!');
            console.log('ðŸŽ® Mouse Controls:');
            console.log('  â€¢ Drag: Rotate camera');
            console.log('  â€¢ Scroll: Zoom in/out');
            console.log('ðŸŽ¯ Scene Controls:');
            console.log('  â€¢ R: Reset camera position');
            console.log('  â€¢ S: Toggle starfield');
            console.log('  â€¢ Z: Toggle scoring zone indicators');
            console.log('  â€¢ X: Clear visual indicators');
            console.log('  â€¢ M: Toggle dartboard center marker');
            console.log('ðŸŽ¯ Dartboard Calibration:');
            console.log('  â€¢ Arrow Keys: Adjust X/Y offset (Â±0.5)');
            console.log('  â€¢ , / . : Adjust Z offset backward/forward (Â±0.5)');
            console.log('  â€¢ 0: Reset dartboard offset to calibrated default');
            console.log('  â€¢ Enter: Save current calibration to localStorage');
            console.log('  â€¢ Backspace: Clear saved calibration and reset');
            console.log('ðŸŽ¯ 3-Throw Round System:');
            console.log('  â€¢ Enter player name to start 3-throw round');
            console.log('  â€¢ System automatically tracks throws and scores');
            console.log('  â€¢ Round completes after 3 throws, ready for next player');
            console.log('ðŸŽ¯ Round Controls:');
            console.log('  â€¢ Ctrl+T: Export round history');
            console.log('  â€¢ Ctrl+C: Clear round history');
            console.log('  â€¢ Ctrl+F: Force end current throw');
            console.log('  â€¢ Ctrl+R: Force end current round');
            console.log('ðŸ“Š Scoring: 3 throws per round, automatic detection and scoring');
        }

        // Initialize the application when DOM is loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>